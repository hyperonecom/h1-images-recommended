name: Build

on:
  push:
    branches:
      - gh-actions
  schedule:
    - cron:  '0 0 * * *'

jobs:
  config:
    runs-on: self-hosted
    outputs:
      matrix-packer: ${{ steps.set-matrix.outputs.matrix-packer }}
      matrix-windows: ${{ steps.set-matrix.outputs.matrix-windows }}
    steps:
      - uses: actions/checkout@v2
      - name: Set up Node 12.x
        uses: actions/setup-node@v1
        with:
          node-version: "12.x"
      - name: Install
        run: npm ci
      - id: set-matrix
        run: node ./.github/render_matrix.js --github
  packer:
    needs: config
    runs-on: self-hosted
    timeout-minutes: 90
    strategy:
      fail-fast: false
      max-parallel: 5
      matrix: ${{fromJson(needs.config.outputs.matrix-packer)}}
    steps:
      - uses: actions/checkout@v2
      - name: Save private SSH key
        run: |
          echo "$PRIVATE_KEY" | openssl base64 -d > ./resources/secrets/id_rsa;
          rm ./resources/ssh/id_rsa*;
          cp ./resources/secrets/* ./resources/ssh/;
          md5sum ./resources/ssh/*
        env:
          PRIVATE_KEY: "${{ secrets.PRIVATE_KEY }}" 
      - name: Build Docker image
        run: docker build -t recommended-images:${{github.sha}} .
      - name: Build Platform image
        run: |
          docker run --rm -e H1_TOKEN -e RBX_TOKEN -e SCOPE -e INFLUXDB_HOST -e INFLUXDB_PASSWORD -e INFLUXDB_USER -e REDHAT_SECRET \
          recommended-images:${{github.sha}} \
          nodejs buildTestPublish.js --config "${{ matrix.config }}" --mode "packer" --cleanup --publish
        env:
          SCOPE: '${{matrix.scope}}'
          H1_TOKEN: '${{secrets.H1_TOKEN}}'
          RBX_TOKEN: '${{secrets.RBX_TOKEN}}'
          INFLUXDB_HOST: '${{secrets.INFLUXDB_HOST}}'
          INFLUXDB_PASSWORD: '${{secrets.INFLUXDB_PASSWORD}}' 
          INFLUXDB_USER: '${{secrets.INFLUXDB_USER}}'
          REDHAT_SECRET: '${{secrets.REDHAT_SECRET}}'
  windows:
    needs: config
    timeout-minutes: 720
    runs-on: self-hosted
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix: ${{fromJson(needs.config.outputs.matrix-windows)}}
    steps:
      - uses: actions/checkout@v2
      - name: Save private SSH key
        run: echo $PRIVATE_KEY > ./resources/secrets/id_rsa
        env:
          PRIVATE_KEY: "${{ secrets.PRIVATE_KEY }}" 
      - name: Build Docker image
        run: docker build -f Dockerfile.windows  -t recommended-images-windows:${{github.sha}} .
      - name: Build Platform image
        run: |
          docker run --rm -e H1_TOKEN -e SCOPE \
          recommended-images-windows:${{github.sha}} \
          nodejs buildTestPublish.js --config "${{ matrix.config }}" --mode "windows" --cleanup --publish
        env:
          SCOPE: '${{matrix.scope}}'
          H1_TOKEN: '${{secrets.H1_TOKEN}}'
          # RBX_TOKEN: '${{secrets.RBX_TOKEN}}'
          # INFLUXDB_HOST: '${{secrets.INFLUXDB_HOST}}'
          # INFLUXDB_PASSWORD: '${{secrets.INFLUXDB_PASSWORD}}' 
          # INFLUXDB_USER: '${{secrets.INFLUXDB_USER}}'
          # REDHAT_SECRET: '${{secrets.H1_TOKEN}}'
