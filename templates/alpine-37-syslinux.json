{
  "variables": {
    "source_image": "image-builder-fedora",
    "efi_fs": "vfat",
    "cloud_fs": "vfat",
    "root_fs": "ext4",
    "features": "ata base ide scsi usb virtio ext4",
    "modules": "sd-mod,usb-storage,ext4",
    "rel": "3.9",
    "mirror": "http://dl-cdn.alpinelinux.org/alpine",
    "apkv": "2.10.3-r1",
    "cloud_init_ds_dir": "/usr/lib/python3.6/site-packages/cloudinit/sources/",
    "cloud_init_ds_src": "./resources/cloud-init/ds_v2/DataSourceRbxCloud.py",
    "cloud_init_tmp_path": "/tmp/cloud_init.py",
    "disk_size": "5",
    "image_name": "Alpine Linux 3.9",
    "image_description": "",
    "linux_package": "linux-virt"
  },
  "builders": [
    {
      "type": "hyperone",
      "vm_name": "packer-5c530ff0-bd94-1870-8fcb-d695f1fe66b7",
      "source_image": "{{user `source_image`}}",
      "vm_type": "a1.medium",
      "disk_size": 10,
      "ssh_keys": [
        "my-ssh"
      ],
      "chroot_disk": true,
      "chroot_command_wrapper": "sudo {{.Command}}",
      "chroot_disk_size": "{{user `disk_size`}}",
      "image_name": "{{user `image_name`}}",
      "image_description": "{{user `image_description`}}",
      "pre_mount_commands": [
        "lsblk",
        "sgdisk -Z {{.Device}}",
        "sgdisk -n 1:0:+52MB {{.Device}}",
        "sgdisk -t 1:8300 {{.Device}}",
        "sgdisk -c 1:EFI {{.Device}}",
        "sgdisk -n 2:0:+52MB {{.Device}}",
        "sgdisk -t 2:EBD0A0A2-B9E5-4433-87C0-68B6B72699C7 {{.Device}}",
        "sgdisk -c 2:CLOUDMD {{.Device}}",
        "sgdisk -n 3:0:+1GB {{.Device}}",
        "sgdisk -t 3:8300 {{.Device}}",
        "sgdisk -c 3:ROOT {{.Device}}",
        "sgdisk -A 3:set:2 {{.Device}}",
        "partprobe",
        "sleep 1",
        "mkfs.fat {{.Device}}1",
        "mkfs.fat {{.Device}}2",
        "dosfslabel {{.Device}}1 EFI",
        "dosfslabel {{.Device}}2 CLOUDMD",
        "mkfs.{{user `root_fs`}} {{.Device}}3",
        "parted {{.Device}} print"
      ],
      "chroot_mount_path": "/tmp/mount",
      "mount_partition": 3,
      "post_mount_commands": [
        "curl -s {{user `mirror`}}/v{{user `rel`}}/main/$(uname -m)/apk-tools-static-{{user `apkv`}}.apk | tar xz",
        "mkdir -p {{.MountPath}}/boot/efi",
        "mount -t vfat {{.Device}}1 {{.MountPath}}/boot/efi",
        "./sbin/apk.static --repository {{user `mirror`}}/v{{user `rel`}}/main --update-cache --allow-untrusted --root {{.MountPath}} --initdb add alpine-base syslinux"
      ]
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "echo \"/dev/sda3    /    ext4    defaults    1    1\" > /etc/fstab"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "echo {{user `mirror`}}/v{{user `rel`}}/main > /etc/apk/repositories",
        "echo '@testing {{user `mirror`}}/edge/testing' >> /etc/apk/repositories",
        "echo '@community {{user `mirror`}}/edge/community' >> /etc/apk/repositories"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "echo overwrite=1  > /etc/update-extlinux.conf",
        "echo vesa_menu=0 >> /etc/update-extlinux.conf",
        "echo default_kernel_opts=\\\"elevator=noop consoleblank=0 console=tty0 console=ttyS0,115200\\\" >> /etc/update-extlinux.conf",
        "echo modules={{user `modules`}}  >> /etc/update-extlinux.conf",
        "echo root=/dev/sda3 >> /etc/update-extlinux.conf",
        "echo verbose=0 >> /etc/update-extlinux.conf",
        "echo hidden=1 >> /etc/update-extlinux.conf",
        "echo timeout=1 >> /etc/update-extlinux.conf",
        "echo default=grsec >> /etc/update-extlinux.conf",
        "echo serial_port= >> /etc/update-extlinux.conf",
        "echo serial_baud=115200 >> /etc/update-extlinux.conf",
        "echo \"password=''\" >> /etc/update-extlinux.conf",
        "sed -e 's;^#ttyS0;ttyS0;g' -i /etc/inittab",
        "cat /etc/update-extlinux.conf"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "cat /etc/update-extlinux.conf"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "cat /etc/mkinitfs/mkinitfs.conf"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "apk add {{user `linux_package`}}",
        "extlinux -i /boot",
        "dd bs=440 conv=notrunc count=1 if=/usr/share/syslinux/gptmbr.bin of=/dev/sdb"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "echo 'nameserver 9.9.9.9' > /etc/resolv.conf",
        "echo 'nameserver 8.8.8.8' > /etc/resolv.conf"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "apk add py3-serial@testing py3-jsonpointer@testing py3-configobj@community py3-jsonschema@community cloud-init@testing py3-attrs cloud-init-openrc@testing",
        "wget https://files.pythonhosted.org/packages/8c/46/4e93ab8a379d7efe93f20a0fb8a27bdfe88942cc954ab0210c3164e783e0/pyrsistent-0.14.11.tar.gz -O /tmp/pyrsistent.tar.gz",
        "tar xvzf /tmp/pyrsistent.tar.gz -C /tmp",
        "cd /tmp/pyrsistent-0.14.11/ && python3 ./setup.py install",
        "echo 'datasource_list: [ RbxCloud ]' > /etc/cloud/cloud.cfg.d/90_dpkg.cfg"
      ]
    },
    {
      "type": "file",
      "source": "{{user `cloud_init_ds_src`}}",
      "destination": "{{user `cloud_init_tmp_path`}}"
    },
    {
      "type": "shell",
      "inline": [
        "mv {{user `cloud_init_tmp_path`}} {{user `cloud_init_ds_dir`}}/DataSourceRbxCloud.py"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "apk -U add haveged && rc-update add haveged",
        "sed \"/after localmount/a  after haveged\" -i /etc/init.d/cloud-init-local"
      ]
    },
    {
      "type": "shell",
      "inline": [
        "ls -lah /usr/lib/python3.6/site-packages/cloudinit/sources/",
        "apk --no-cache add eudev # to provide mdadm required by cloud-init (installed size: 1.17 MB)",
        "apk --no-cache add ifupdown # to provide \"ip --all\" required by cloud-init (installed size: 84 kB)",
        "apk --no-cache add iproute2 # to provide \"ip addr show permanent\" required by cloud-init (installed size: 1.66MB)",
        "# apk --no-cache add dosfstools # to provide \"mkfs.vfat\" for \"devfs\" (installed size: 144 kB)",
        "apk --no-cache add openssh-server # to provide ssh connectivity (managed by cloud-init)",
        "rc-update -q add devfs sysinit",
        "rc-update -q add dmesg sysinit",
        "rc-update -q add mdev sysinit",
        "rc-update -q add hwdrivers sysinit",
        "rc-update -q add hwclock boot",
        "rc-update -q add modules boot",
        "rc-update -q add sysctl boot",
        "rc-update -q add hostname boot",
        "rc-update -q add bootmisc boot",
        "rc-update -q add syslog boot",
        "rc-update -q add networking boot",
        "rc-update -q add urandom boot",
        "rc-update -q add mount-ro shutdown",
        "rc-update -q add killprocs shutdown",
        "rc-update -q add savecache shutdown",
        "rc-update -q add crond default",
        "rc-update -q add sshd default",
        "rc-update -q add cloud-config default",
        "rc-update -q add cloud-final default",
        "rc-update -q add cloud-init-local boot",
        "rc-update -q add cloud-init default"
      ]
    }
  ]
}